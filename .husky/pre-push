#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üöÄ Running pre-push checks..."

# Run all tests
echo "üß™ Running all tests..."
npm run test || {
  echo "‚ùå Tests failed"
  exit 1
}

# Run test coverage check
echo "üìä Checking test coverage..."
npm run test:cov || {
  echo "‚ùå Coverage check failed"
  exit 1
}

# Check for console.log statements (except in test files)
echo "üîç Checking for console.log statements..."
if git diff --cached --name-only --diff-filter=ACM | grep -E '\.ts$' | grep -v '\.spec\.ts$' | xargs grep -n 'console\.log' 2>/dev/null; then
  echo "‚ùå Found console.log statements. Please remove them before pushing."
  exit 1
fi

# Security audit
echo "üîí Running security audit..."
npm audit --audit-level=high || {
  echo "‚ö†Ô∏è  Security vulnerabilities found. Please review."
  exit 1
}

# SonarCloud Quality Gate check (optional - requires sonar-scanner-cli)
echo "üìä Checking SonarCloud Quality Gates..."
if command -v sonar-scanner &> /dev/null; then
  echo "Running SonarCloud analysis..."
  sonar-scanner \
    -Dsonar.qualitygate.wait=true \
    -Dsonar.login=${SONAR_TOKEN:-} || {
    echo "‚ö†Ô∏è  SonarCloud quality gate failed or SONAR_TOKEN not set"
    echo "To enable SonarCloud checks locally, install sonar-scanner-cli and set SONAR_TOKEN"
    echo "Continuing without SonarCloud validation..."
  }
else
  echo "‚ÑπÔ∏è  sonar-scanner not installed. Skipping local SonarCloud check."
  echo "Quality gates will be validated in CI/CD pipeline."
fi

echo "‚úÖ Pre-push checks passed!"
